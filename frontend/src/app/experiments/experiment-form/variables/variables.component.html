<div [formGroup]="parentForm()">

  <!-- Variables Configuration-->
  <fieldset formArrayName="variables">
    <legend>Variables</legend>

    <!-- Variable Groups -->
    <div class="variables">
      @for(variable of variables.controls; let i = $index; track i) {

        <!-- Remove Variable Button -->
        @if((i === variables.length - 1) && (variables.length > 1)) {
          <button type="button" (click)="removeVariable(i)" class="btn control-variable">
            - - Delete - -
          </button> 
        }

        <div class="variable-title">
          <h3>Variable {{i + 1}}</h3>

          <!-- Validation Configuration Toggle Button -->
          <button type="button" class="btn btn-link advanced-config"
            (click)="toggleVariableCollapse(i)">
            {{ isVariableOpen[i] ? 'Hide validation configuration' : 'Show validation configuration' }}
          </button>
        </div>

        <div class="variable-group">

          <!-- Variable Fields -->
          <div [formGroupName]="i">
            <div class="variable-group-main">
              <!-- Name Field -->
              <label for="variable-{{i}}-name">Name</label>
              <input
                class="form-control"
                [ngClass]="{
                  'is-invalid': submitted() && (isFieldInvalid('variables.' + i + '.name', 'required') || isFieldInvalid('variables.' + i + '.name', 'maxlength'))
                }"
                type="text"
                id="variable-{{i}}-name"
                formControlName="name"
                placeholder="Introduce a variable name"
              >

              <!-- Type Field -->
              <label for="variable-{{i}}-type">Type</label>
              <select 
                id="variable-{{i}}-type" 
                class="form-control"
                [ngClass]="{
                  'is-invalid': submitted() && (isFieldInvalid('variables.' + i + '.type', 'required'))
                }"
                formControlName="type" 
                (change)="onVariableTypeChange(i)"
              >
                <option value="" disabled selected>Select type</option>
                @for(type of variableTypes; track type.value) {
                  <option [value]="type.value">{{ type.label }}</option>
                }
              </select>
            </div>

            @if (submitted() && isFieldInvalid('variables.' + i + '.name', 'required')) {
              <small class="text-danger error-message">Name is required</small>
            }
            @if (submitted() && isFieldInvalid('variables.' + i + '.name', 'maxlength')) {
              <small class="text-danger">Name must be less than 100 characters</small>
            }
            @if (submitted() && isFieldInvalid('variables.' + i + '.type', 'required')) {
              <small class="text-danger error-message">Type is required</small>
            }

            <!-- Validation Configuration Fields -->
            <div [collapse]="!isVariableOpen[i]" formGroupName="validations" class="validations">

              <!-- Description Field -->
              <div class="form-group-item">
                <label for="variable-{{i}}-description">Description</label>
                <textarea 
                  id="variable-{{i}}-description" 
                  formControlName="description"
                  class="form-control"
                  placeholder="Introduce variable description"
                ></textarea>
              </div>

              <!-- Required Field -->
              <div class="form-group-item">
                <label for="variable-{{i}}-required">Required</label>
                <input id="variable-{{i}}-required" type="checkbox" formControlName="required"/>
              </div>

              <!-- Array validations Field -->
              @if((getVariableType(i) === variableType.STRING_ARRAY) || (getVariableType(i) === variableType.NUMBER_ARRAY) 
                || (getVariableType(i) === variableType.BOOLEAN_ARRAY) || (getVariableType(i) === variableType.OBJECT_ARRAY)) {
                <div class="form-group-item">
                  <label for="variable-{{i}}-minItems">Min Items</label>
                  <input 
                    id="variable-{{i}}-minItems" 
                    type="number" 
                    formControlName="minItems"
                    class="form-control"
                    placeholder="Introduce min items"
                  />
                </div>

                <div class="form-group-item">
                  <label for="variable-{{i}}-maxItems">Max Items</label>
                  <input 
                    id="variable-{{i}}-maxItems" 
                    type="number" 
                    formControlName="maxItems" 
                    class="form-control"
                    placeholder="Introduce max items"
                  />
                </div>

                <div class="form-group-item">
                  <label for="variable-{{i}}-uniqueItems">Unique Items</label>
                  <input 
                    id="variable-{{i}}-uniqueItems" 
                    type="checkbox" 
                    formControlName="uniqueItems"
                  />
                </div>

                @if(getVariableType(i) !== variableType.BOOLEAN_ARRAY){
                  <h3>Items Validation</h3>
                }
              }

              <!-- String validations Field -->
              @if((getVariableType(i) === variableType.STRING) || (getVariableType(i) === variableType.STRING_ARRAY)) {
                <div class="form-group-item">
                  <label for="variable-{{i}}-minLength">Min Length</label>
                  <input 
                    id="variable-{{i}}-minLength" 
                    type="number" 
                    formControlName="minLength" 
                    class="form-control"
                    placeholder="Introduce min length"
                  />
                </div>

                <div class="form-group-item">
                  <label for="variable-{{i}}-maxLength">Max Length</label>
                  <input 
                    id="variable-{{i}}-maxLength" 
                    type="number" 
                    formControlName="maxLength" 
                    class="form-control"
                    placeholder="Introduce max length"
                  />
                </div>

                <div class="form-group-item">
                  <label for="variable-{{i}}-format">Format</label>
                  <input 
                    id="variable-{{i}}-format"
                    type="text" 
                    formControlName="format" 
                    class="form-control"
                    placeholder="Introduce format"
                  />
                </div>

                <div class="form-group-item">
                  <label for="variable-{{i}}-pattern">Pattern</label>
                  <input 
                    id="variable-{{i}}-pattern" 
                    type="text" 
                    formControlName="pattern" 
                    class="form-control"
                    placeholder="Introduce pattern"
                  />
                </div>
              }

              <!-- Number validations Field -->
              @if((getVariableType(i) === variableType.NUMBER) || (getVariableType(i) === variableType.NUMBER_ARRAY)) {
                <div class="form-group-item">
                  <label for="variable-{{i}}-minimum">Minimum</label>
                  <input 
                    id="variable-{{i}}-minimum" 
                    type="number" 
                    formControlName="minimum" 
                    class="form-control"
                    placeholder="Introduce minimum"
                  />
                </div>

                <div class="form-group-item">
                  <label for="variable-{{i}}-maximum">Maximum</label>
                  <input 
                    id="variable-{{i}}-maximum" 
                    type="number" 
                    formControlName="maximum" 
                    class="form-control"
                    placeholder="Introduce maximum"
                  />
                </div>

                <div class="form-group-item">
                  <label for="variable-{{i}}-exclusiveMinimum">Exclusive Minimum</label>
                  <input 
                    id="variable-{{i}}-exclusiveMinimum" 
                    type="number" 
                    formControlName="exclusiveMinimum" 
                    class="form-control"
                    placeholder="Introduce exclusive minimum"
                  />
                </div>

                <div class="form-group-item">
                  <label for="variable-{{i}}-exclusiveMaximum">Exclusive Maximum</label>
                  <input 
                    id="variable-{{i}}-exclusiveMaximum" 
                    type="number" 
                    formControlName="exclusiveMaximum" 
                    class="form-control"
                    placeholder="Introduce exclusive maximum"
                  />
                </div>
              }

              <!-- Object validations Field -->
              @if(getVariableType(i) === variableType.OBJECT || (getVariableType(i) === variableType.OBJECT_ARRAY)) {
                <div class="form-group-item">
                  <label for="variable-{{i}}-properties">Properties</label>
                  <input 
                    id="variable-{{i}}-properties" 
                    type="text" 
                    formControlName="properties" 
                    class="form-control"
                    placeholder="Introduce properties (e.g., prop1, prop2, prop3)"
                  />
                </div>

                <div class="form-group-item">
                  <label for="variable-{{i}}-minProperties">Min Properties</label>
                  <input 
                    id="variable-{{i}}-minProperties" 
                    type="number" 
                    formControlName="minProperties" 
                    class="form-control"
                    placeholder="Introduce min properties"
                  />
                </div>

                <div class="form-group-item">
                  <label for="variable-{{i}}-maxProperties">Max Properties</label>
                  <input 
                    id="variable-{{i}}-maxProperties" 
                    type="number" 
                    formControlName="maxProperties" 
                    class="form-control"
                    placeholder="Introduce max properties"
                  />
                </div>
              } 
            </div>
          </div>
        </div>

        <!-- Add Variable Button -->
        @if(i === variables.length - 1) {
          <button type="button" (click)="addVariable()" class="btn control-variable">
            - - Add variable - -
          </button>
        }
      }
    </div>
  </fieldset>
</div>
